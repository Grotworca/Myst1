<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <title>WebAR ‚Äì czarodziej na markerze</title>

  <!-- LOKALNE biblioteki -->
  <script src="libs/aframe-v1.2.0.min.js"></script>        <!-- A-Frame 1.2.0 -->
  <script src="libs/mindar-image.prod.js"></script>        <!-- MindAR core -->
  <script src="libs/mindar-image-aframe.prod.js"></script> <!-- Bridge A-Frame ‚Üî MindAR -->

  <style>
    body { margin:0; overflow:hidden; font-family:system-ui,Arial }
    #msg { position:fixed; inset:0;
           display:flex; align-items:center; justify-content:center;
           background:#000; color:#fff; font-size:18px; text-align:center; z-index:9 }
    a-scene { width:100vw; height:100vh }
  </style>
</head>
<body>
  <div id="msg">üîç ≈Åadowanie‚Ä¶</div>

  <a-scene id="scene" embedded
           mindar-image="imageTargetSrc:targets.mind; autoStart:true;"
           vr-mode-ui="enabled:false"
           device-orientation-permission-ui="enabled:true">

    <a-assets>
      <img id="overlay" src="assets/czarodziej.png">
    </a-assets>

    <a-camera look-controls="enabled:false"></a-camera>
    <a-entity id="anchor" mindar-image-target="targetIndex:0"></a-entity>
  </a-scene>

<script>
(async () => {
  const box  = txt => (MSG.textContent = txt, MSG.style.display = 'flex');
  const hide = ()  => (MSG.style.display = 'none');
  const MSG  = document.getElementById('msg');

  /* 1Ô∏è‚É£  biblioteki wczytane? */
  if (typeof AFRAME !== 'object')           { box('‚ùå A-Frame nieza≈Çadowany'); return; }
  if (typeof window.MINDAR === 'undefined') { box('‚ùå MindAR nieza≈Çadowany');  return; }

  /* 2Ô∏è‚É£  targets.mind istnieje i ma dane */
  const ok = await fetch('targets.mind', {cache:'no-store'})
                    .then(r => r.ok && r.headers.get('content-length') !== '0')
                    .catch(() => false);
  if (!ok) { box('‚ùå Brak lub pusty targets.mind'); return; }

  /* 3Ô∏è‚É£  zgoda na tylnƒÖ kamerƒô */
  try {
    const s = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal:'environment' } }
    });
    s.getTracks().forEach(t => t.stop());   // zwalniamy ‚Äì MindAR przejmie p√≥≈∫niej
  } catch (e) {
    box('‚ùå Kamera zablokowana'); return;
  }

  /* 4Ô∏è‚É£  uruchamiamy scenƒô */
  hide();
  const anchor = document.getElementById('anchor');
  const scene  = document.getElementById('scene');

  scene.addEventListener('targetFound', () => {
    if (!anchor.children.length) {
      const p = document.createElement('a-plane');
      p.setAttribute('src',    '#overlay');
      p.setAttribute('width',  '1');
      p.setAttribute('height', '0.75');
      p.setAttribute('material', 'shader:flat;transparent:true');
      anchor.appendChild(p);
    }
  });

  scene.addEventListener('targetLost', () => anchor.innerHTML = '');
})();
</script>
</body>
</html>
