<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8">
  <title>WebAR ‚Äì S1DOM & S1NAMIOT</title>

  <!-- biblioteki lokalne -->
  <script src="libs/aframe-v1.2.0.min.js"></script>
  <script src="libs/mindar-image.prod.js"></script>
  <script src="libs/mindar-image-aframe.prod.js"></script>
  <!-- GIF-y? zostaw; nie potrzebujesz ‚Äì usu≈Ñ linijkƒô -->
  <script src="https://cdn.jsdelivr.net/gh/richard-hart/aframe-gif-shader@master/dist/aframe-gif-shader.min.js"></script>

  <style>
    body{margin:0;overflow:hidden;font-family:system-ui,Arial}
    #msg{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
         background:#000;color:#fff;font-size:18px;text-align:center;z-index:9}
    a-scene{width:100vw;height:100vh}
  </style>
</head>
<body>
<div id="msg">üîç ≈Åadowanie‚Ä¶</div>

<a-scene id="scene" embedded
         mindar-image="imageTargetSrc:targets.mind;autoStart:true;"
         vr-mode-ui="enabled:false"
         device-orientation-permission-ui="enabled:true">

  <a-assets>
    <img id="S1DOM_X"    src="assets/S1DOM_X.png">
    <img id="S1NAMIOT_X" src="assets/S1NAMIOT_X.png">
  </a-assets>

  <a-camera look-controls="enabled:false"></a-camera>
  <a-entity id="anchor" mindar-image-target="targetIndex:0"></a-entity>
</a-scene>

<script>
(async()=>{
/* ======= mapowanie index ‚Üí id nak≈Çadki =================== */
const mapping = {
  0 : 'S1DOM_X',      // S1DOM  ‚Üí S1DOM_X.png
  1 : 'S1NAMIOT_X'    // S1NAMIOT ‚Üí S1NAMIOT_X.png
};
/* ========================================================= */

const box=(t)=>{MSG.textContent=t;MSG.style.display='flex'}, hide=()=>MSG.style.display='none';
const MSG=document.getElementById('msg');

/* sanity-check */
if(typeof AFRAME!=='object'){box('‚ùå A-Frame nieza≈Çadowany');return}
if(typeof MINDAR==='undefined'){box('‚ùå MindAR nieza≈Çadowany');return}
if(!(await fetch('targets.mind').then(r=>r.ok&&r.headers.get('content-length')!=='0').catch(()=>0))){
  box('‚ùå brak / pusty targets.mind');return}
try{const s=await navigator.mediaDevices.getUserMedia({video:true});s.getTracks().forEach(t=>t.stop());}
catch{box('‚ùå kamera zablokowana');return}

hide();

/* aspect-ratio cache */
const aspects={}, anchor=document.getElementById('anchor');
const scene =document.getElementById('scene');
function aspect(el){return el.naturalHeight/el.naturalWidth}
function spawn(assetId){
  const tex=document.getElementById(assetId); if(!tex) return;
  const h=aspects[assetId] ||= aspect(tex);
  const p=document.createElement('a-plane');
  p.setAttribute('src','#'+assetId);
  p.setAttribute('width','1'); p.setAttribute('height',h);
  const gif=tex.src.toLowerCase().endsWith('.gif');
  p.setAttribute('material', gif ? 'shader:gif;src:#'+assetId
                                 : 'shader:flat;transparent:true');
  anchor.appendChild(p);
}

/*   global listener ‚Äì zdarzenie sceny ma detail.index   */
scene.addEventListener('targetFound', e=>{
  if(!e.detail||typeof e.detail.index==='undefined') return;   // filtr <video>
  const idx=e.detail.index;  console.log('FOUND index',idx,e.detail.name);
  const id=mapping[idx]; if(!id) return;
  anchor.innerHTML='';      // wyczy≈õƒá poprzedni
  const tex=document.getElementById(id);
  tex.complete ? spawn(id) : tex.onload=()=>spawn(id);
});
scene.addEventListener('targetLost',()=>anchor.innerHTML='');
})();
</script>
</body>
</html>
