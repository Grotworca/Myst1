<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8">
<title>MindAR debug – NIC nie rysuj przed markerem</title>

<script src="https://cdn.jsdelivr.net/gh/MindAR-js/aframe/dist/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/MindAR-js/aframe/dist/mindar-image.prod.js"></script>
<script src="https://cdn.jsdelivr.net/gh/MindAR-js/aframe/dist/mindar-image-aframe.prod.js"></script>

<style>
body{margin:0;overflow:hidden}
#loading{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
         background:#000;color:#fff;font-size:18px;z-index:9}
a-scene{width:100vw;height:100vh}
</style>
</head>
<body>
<div id="loading">🔍 Inicjalizacja…</div>

<a-scene id="scene"
         embedded
         mindar-image="imageTargetSrc: targets.mind; autoStart: true;"
         vr-mode-ui="enabled:false"
         device-orientation-permission-ui="enabled:true">

  <a-assets>
    <img id="tex" src="assets/czarodziej.png">
  </a-assets>

  <a-camera look-controls="enabled:false"></a-camera>
  <!-- pusta kotwica – na start NIC w niej nie ma -->
  <a-entity id="anchor" mindar-image-target="targetIndex:0"></a-entity>
</a-scene>

<script>
(async()=>{
  const log = msg => console.log('%c'+msg,'color:lime');
  const err = msg => console.error('%c'+msg,'color:red');
  const loading = document.getElementById('loading');

  /* 1. targets.mind? */
  const ok = await fetch('targets.mind').then(r=>r.ok).catch(()=>false);
  if(!ok){loading.textContent='❌ brak targets.mind'; return err('404 targets.mind');}

  /* 2. tylna kamera – tylko by dostać permission, strumień natychmiast zwalniamy */
  try{
    const s = await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:'environment'}}});
    s.getTracks().forEach(t=>t.stop());
    log('kamera OK (environment)');
  }catch(e){
    loading.textContent='❌ kamera zablokowana'; err(e); return;
  }

  /* 3. chowamy loader, scena gotowa */
  loading.remove();

  const anchor=document.getElementById('anchor');
  const scene = document.getElementById('scene');

  /* 4. Reagujemy tylko na prawdziwe zdarzenia */
  scene.addEventListener('targetFound',()=>{
    log('🎯 targetFound');
    if(anchor.children.length===0){
      const p=document.createElement('a-plane');
      p.setAttribute('src','#tex');
      p.setAttribute('width','1');
      p.setAttribute('height','0.75');
      p.setAttribute('material','shader:flat;transparent:true');
      anchor.appendChild(p);
      log('▶️ plane dodany do anchor');
    }
  });

  scene.addEventListener('targetLost',()=>{
    log('👋 targetLost – usuwam plane');
    anchor.innerHTML='';
  });
})();
</script>
</body></html>
