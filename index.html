<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8">
  <title>WebAR ‚Äì precyzyjna nak≈Çadka</title>

  <!-- lokalne biblioteki -->
  <script src="libs/aframe-v1.2.0.min.js"></script>
  <script src="libs/mindar-image.prod.js"></script>
  <script src="libs/mindar-image-aframe.prod.js"></script>

  <style>
    body { margin:0; overflow:hidden; font-family:system-ui,Arial }
    #msg  { position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
            background:#000; color:#fff; font-size:18px; text-align:center; z-index:9 }
    a-scene { width:100vw; height:100vh }
  </style>
</head>
<body>
<div id="msg">üîç ≈Åadowanie‚Ä¶</div>

<a-scene id="scene" embedded
         mindar-image="imageTargetSrc:targets.mind; autoStart:true;"
         vr-mode-ui="enabled:false"
         device-orientation-permission-ui="enabled:true">

  <a-assets>
    <!-- PNG pojawi siƒô na markerze -->
    <img id="overlay" src="assets/czarodziej.png">
  </a-assets>

  <a-camera look-controls="enabled:false"></a-camera>
  <a-entity id="anchor" mindar-image-target="targetIndex:0"></a-entity>
</a-scene>

<script>
(async () => {
  const MSG = document.getElementById('msg');
  const show = t => (MSG.textContent=t, MSG.style.display='flex');
  const hide = () =>  MSG.style.display='none';

  /* 1. weryfikacja bibliotek */
  if (typeof AFRAME!=='object')           { show('‚ùå A-Frame nieza≈Çadowany'); return; }
  if (typeof window.MINDAR==='undefined'){ show('‚ùå MindAR nieza≈Çadowany');  return; }

  /* 2. czy jest plik targets.mind (>0 B) */
  const ok = await fetch('targets.mind',{cache:'no-store'})
                    .then(r=>r.ok && r.headers.get('content-length')!=='0')
                    .catch(()=>false);
  if (!ok){ show('‚ùå Brak / pusty targets.mind'); return; }

  /* 3. popro≈õ o tylnƒÖ kamerƒô (permission) */
  try{
    const s = await navigator.mediaDevices.getUserMedia({
      video:{ facingMode:{ ideal:'environment' } }
    });
    s.getTracks().forEach(t=>t.stop());
  }catch(e){ show('‚ùå Kamera zablokowana'); return; }

  hide();                                 /* wszystko OK */

  const scene  = document.getElementById('scene');
  const anchor = document.getElementById('anchor');
  const img    = document.getElementById('overlay');

  /* 4. czekaj a≈º obrazek siƒô za≈Çaduje, ≈ºeby znaƒá naturalny rozmiar */
  await new Promise(res=>{
    if (img.complete) res(); else img.onload = res;
  });

  const aspect = img.naturalHeight / img.naturalWidth;   // np. 0.75
  const yOffset = 0;   // ‚Üê je≈õli PNG ma pusty margines u g√≥ry/dole, wpisz np. -0.05

  scene.addEventListener('targetFound', () => {
    if (anchor.children.length) return;

    const plane = document.createElement('a-plane');
    plane.setAttribute('src', '#overlay');
    plane.setAttribute('width',  '1');
    plane.setAttribute('height', aspect.toString());      // dopasuj wysoko≈õƒá
    plane.setAttribute('position', `0 ${yOffset} 0`);     // ≈õrodek markera (ew. korekta Y)
    plane.setAttribute('material', 'shader:flat;transparent:true');
    anchor.appendChild(plane);
  });

  scene.addEventListener('targetLost', () => anchor.innerHTML = '');
})();
</script>
</body>
</html>
