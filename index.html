<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <title>WebAR – pojawia się tylko na markerze</title>

  <!-- A-Frame + MindAR -->
  <script src="https://cdn.jsdelivr.net/gh/MindAR-js/aframe/dist/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/MindAR-js/aframe/dist/mindar-image.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/MindAR-js/aframe/dist/mindar-image-aframe.prod.js"></script>

  <style>
    body{margin:0;overflow:hidden}
    #loading{position:fixed;inset:0;display:flex;align-items:center;
             justify-content:center;background:#000;color:#fff;z-index:9}
    a-scene{width:100vw;height:100vh}
  </style>
</head>
<body>
  <div id="loading">🔍 Włączanie tylnej kamery…</div>

  <a-scene id="scene"
           mindar-image="imageTargetSrc: targets.mind; autoStart: true;"
           embedded color-space="sRGB"
           renderer="colorManagement: true; physicallyCorrectLights"
           vr-mode-ui="enabled:false"
           device-orientation-permission-ui="enabled:true">

    <a-assets>
      <img id="czarodziej" src="assets/czarodziej.png">
    </a-assets>

    <a-camera position="0 0 0" look-controls="enabled:false"></a-camera>

    <!-- Pusta kotwica – bez potomków = nie ma co wyświetlić -->
    <a-entity id="anchor" mindar-image-target="targetIndex:0"></a-entity>
  </a-scene>

  <script>
    // najpierw sprawdzamy plik + tylną kamerę
    (async()=>{

      /* 1. sprawdź targets.mind */
      const ok = await fetch('targets.mind').then(r=>r.ok);
      if (!ok){return document.getElementById('loading').innerText='❌ Brak targets.mind';}

      /* 2. poproś o tylną kamerę – tylko by uzyskać uprawnienie,
            natychmiast zwalniamy strumień                */
      try{
        const s = await navigator.mediaDevices.getUserMedia({
          video:{facingMode:{ideal:'environment'}}
        });
        s.getTracks().forEach(t=>t.stop());
      }catch(e){
        return document.getElementById('loading').innerText='❌ Kamera zablokowana';
      }

      /* 3. ukryj ekran ładowania */
      document.getElementById('loading').style.display='none';

      /* 4. po załadowaniu sceny dodajemy grafikę dopiero przy targetFound */
      const anchor   = document.getElementById('anchor');
      const sceneEl  = document.getElementById('scene');

      let spawned=false;

      sceneEl.addEventListener('targetFound',()=>{
        if(spawned) return;

        const plane=document.createElement('a-plane');
        plane.setAttribute('src','#czarodziej');
        plane.setAttribute('width','1');       // skala względem markera
        plane.setAttribute('height','0.75');
        plane.setAttribute('rotation','0 0 0');
        plane.setAttribute('position','0 0 0');
        plane.setAttribute('material','shader:flat;transparent:true');

        anchor.appendChild(plane);
        spawned=true;
      });

      sceneEl.addEventListener('targetLost',()=>{
        // opcjonalnie możesz usunąć obiekt, aby tworzył się za każdym razem
        //   anchor.innerHTML=''; spawned=false;
      });
    })();
  </script>
</body>
</html>
