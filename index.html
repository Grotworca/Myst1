<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>WebAR – Czarodziej (tylna kamera)</title>

  <!-- A-Frame & MindAR -->
  <script src="https://cdn.jsdelivr.net/gh/MindAR-js/aframe/dist/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/MindAR-js/aframe/dist/mindar-image.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/MindAR-js/aframe/dist/mindar-image-aframe.prod.js"></script>

  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div id="loading">🔍 Przygotowywanie kamery...</div>

  <!-- Scena zostanie pokazana po pozytywnych testach -->
  <div id="scene-container" style="display:none;">
    <a-scene
      mindar-image="imageTargetSrc: targets.mind; autoStart: true;"
      embedded
      color-space="sRGB"
      renderer="colorManagement: true, physicallyCorrectLights"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: true">

      <a-assets>
        <img id="czarodziej" src="assets/czarodziej.png" />
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled:false"></a-camera>

      <!-- obiekt widoczny tylko przy wykryciu markera -->
      <a-entity mindar-image-target="targetIndex: 0" id="target" visible="false">
        <a-entity geometry="primitive: plane; width: 1; height: 0.75"
                  material="shader: flat; src: #czarodziej">
        </a-entity>
      </a-entity>
    </a-scene>
  </div>

  <script>
    // test: tylny aparat + istnienie targets.mind
    async function init() {
      const loading = document.getElementById("loading");
      const scene   = document.getElementById("scene-container");

      try {
        // sprawdź targets.mind
        const res = await fetch("targets.mind");
        if (!res.ok) throw new Error("Nie znaleziono pliku targets.mind");

        // poproś explicite o tylną kamerę
        const stream = await navigator.mediaDevices.getUserMedia({
          video: { facingMode: { ideal: "environment" } }
        });
        // zwolnij – MindAR pobierze strumień sam
        stream.getTracks().forEach(t => t.stop());

        // gotowe → pokazujemy scenę
        loading.style.display = "none";
        scene.style.display   = "block";
      } catch (e) {
        loading.innerText = "❌ Błąd: " + e.message;
      }

      // logika widoczności obiektu
      document.addEventListener("DOMContentLoaded", () => {
        const sceneEl  = document.querySelector("a-scene");
        const targetEl = document.querySelector("#target");

        if (!sceneEl || !targetEl) return;

        sceneEl.addEventListener("targetFound", ()  => targetEl.setAttribute("visible", "true"));
        sceneEl.addEventListener("targetLost",  ()  => targetEl.setAttribute("visible", "false"));
      });
    }

    init();
  </script>
</body>
</html>
