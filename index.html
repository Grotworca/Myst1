<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <title>WebAR ‚Äì Dom & Namiot (multi-device)</title>

  <!-- lokalne biblioteki -->
  <script src="libs/aframe-v1.2.0.min.js"></script>
  <script src="libs/mindar-image.prod.js"></script>
  <script src="libs/mindar-image-aframe.prod.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: system-ui;
      height: 100%;
      background: transparent;
    }
    /* komunikat startowy (zniknie po inicjalizacji) */
    #msg {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      font-size: 18px;
      text-align: center;
      z-index: 9;
    }
    /* sta≈Çe logo */
    #hud-logo {
      position: fixed;
      top: 8px;
      left: 8px;
      width: 64px;
      height: auto;
      background: #ffffffb0;
      border: 2px solid #fff;
      border-radius: 8px;
      z-index: 10000;
      pointer-events: none;
    }
    /* scena AR ‚Äì t≈Ço przezroczyste, bez niebieskiego ekranu ≈Çadowania */
    a-scene {
      width: 100vw;
      height: 100vh;
      background: transparent !important;
    }
  </style>
</head>
<body>

  <!-- sta≈Çe logo -->
  <img id="hud-logo" src="assets/WIZJA.png" alt="logo">

  <!-- komunikat startowy -->
  <div id="msg">üîç ≈Åadowanie‚Ä¶</div>

  <!-- scena WebAR -->
  <a-scene id="scene" embedded
           background="color: transparent"
           mindar-image="imageTargetSrc: targets.mind; autoStart: true; filterBeta: 0.5;"
           vr-mode-ui="enabled: false"
           device-orientation-permission-ui="enabled: true">

    <a-assets>
      <!-- Nak≈Çadki (dok≈Çadnie przyciƒôte do rozmiaru marker√≥w, bez margines√≥w) -->
      <img id="tex-dom"    src="assets/S1DOM_X.png">
      <img id="tex-namiot" src="assets/S1NAMIOT_X.png">
    </a-assets>

    <!-- UWAGA: dla iOS wa≈ºne, ≈ºeby by≈Ço mindar-image-camera -->
    <a-camera mindar-image-camera look-controls="enabled: false" />

    <!-- kotwice: 0 = Namiot, 1 = Dom -->
    <a-entity id="anchor-namiot" mindar-image-target="targetIndex: 0"></a-entity>
    <a-entity id="anchor-dom"    mindar-image-target="targetIndex: 1"></a-entity>
  </a-scene>

<script>
(async()=>{
  // 1. Weryfikacja bibliotek i targets.mind
  const M = document.getElementById('msg');
  try {
    if (typeof AFRAME !== 'object') throw '‚ùå A-Frame nieza≈Çadowany';
    if (typeof MINDAR === 'undefined') throw '‚ùå MindAR nieza≈Çadowany';
    const res = await fetch('targets.mind');
    if (!res.ok || res.headers.get('content-length') === '0') throw '‚ùå brak lub pusty targets.mind';
    // uzyskaj pozwolenie na kamerƒô (potrzebne na niekt√≥rych urzƒÖdzeniach mobilnych)
    await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
      .then(stream => stream.getTracks().forEach(t => t.stop()));
    M.style.display = 'none';
  } catch(e) {
    M.textContent = e;
    return;
  }

  // 2. Funkcja dodajƒÖca overlay dopasowany do marker√≥w
  function addPlane(anchorEl, texSelector) {
    const img = document.querySelector(texSelector);
    if (!img) return;
    const aspect = img.naturalHeight / img.naturalWidth;
    anchorEl.innerHTML = '';
    const plane = document.createElement('a-plane');
    plane.setAttribute('src', texSelector);
    plane.setAttribute('width', '1');
    plane.setAttribute('height', aspect.toString());
    plane.setAttribute('position', '0 0 0.005'); // nie zas≈Çania punkt√≥w detekcji
    plane.setAttribute('material', 'shader:flat;transparent:true');
    anchorEl.appendChild(plane);
  }

  // 3. Kotwice Markery
  const anchorN = document.getElementById('anchor-namiot');
  anchorN.addEventListener('targetFound', () => {
    addPlane(anchorN, '#tex-namiot');
  });
  anchorN.addEventListener('targetLost', () => anchorN.innerHTML = '');

  const anchorD = document.getElementById('anchor-dom');
  anchorD.addEventListener('targetFound', () => {
    addPlane(anchorD, '#tex-dom');
  });
  anchorD.addEventListener('targetLost', () => anchorD.innerHTML = '');

  // 4. Na iOS konieczne czasem op√≥≈∫nienie startu AR, a≈º <a-scene> bƒôdzie gotowa
  document.querySelector('a-scene').addEventListener('renderstart', () => {
    // MindAR jest ju≈º w≈ÇƒÖczone, nie trzeba nic wiƒôcej robiƒá
    // (w razie potrzeby mo≈ºna dodaƒá dodatkowe inicjacje tutaj)
  });
})();
</script>
</body>
</html>
