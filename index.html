<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="utf-8">
<title>WebAR multi-marker ‚Äì safe</title>

<script src="libs/aframe-v1.2.0.min.js"></script>
<script src="libs/mindar-image.prod.js"></script>
<script src="libs/mindar-image-aframe.prod.js"></script>
<script src="https://cdn.jsdelivr.net/gh/richard-hart/aframe-gif-shader@master/dist/aframe-gif-shader.min.js"></script>

<style>
 body{margin:0;overflow:hidden;font-family:system-ui}
 #msg{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
      background:#000;color:#fff;font-size:18px;text-align:center;z-index:9}
 a-scene{width:100vw;height:100vh}
</style>
</head>
<body>
<div id="msg">üîç ≈Åadowanie‚Ä¶</div>

<a-scene id="scene" embedded
         mindar-image="imageTargetSrc:targets.mind;autoStart:true;"
         vr-mode-ui="enabled:false"
         device-orientation-permission-ui="enabled:true">

  <a-assets>
    <img id="S1NAMIOT_X" src="assets/S1NAMIOT_X.png">
    <img id="S1DOM_X"    src="assets/S1DOM_X.png">
  </a-assets>

  <a-camera look-controls="enabled:false"></a-camera>
  <a-entity id="anchor" mindar-image-target="targetIndex:0"></a-entity>
</a-scene>

<script>
(async()=>{
/* -------- M A P P I N G  (index ‚Üí asset-id) -------- */
const mapping={
  0:'S1NAMIOT_X',   // marker 0  ‚Üí nak≈Çadka
  1:'S1DOM_X'       // marker 1  ‚Üí nak≈Çadka
};
/* --------------------------------------------------- */

const MSG=document.getElementById('msg');
const show=t=>(MSG.textContent=t,MSG.style.display='flex'),hide=()=>MSG.style.display='none';

/* szybka kontrola bibliotek / plik√≥w (jak wcze≈õniej) */
if(typeof AFRAME!=='object'){show('‚ùå A-Frame nieza≈Çadowany');return}
if(typeof MINDAR==='undefined'){show('‚ùå MindAR nieza≈Çadowany');return}
if(!(await fetch('targets.mind').then(r=>r.ok&&r.headers.get('content-length')!=='0').catch(()=>0))){
  show('‚ùå brak / pusty targets.mind');return}
try{const s=await navigator.mediaDevices.getUserMedia({video:true});s.getTracks().forEach(t=>t.stop())}
catch{show('‚ùå kamera zablokowana');return}

hide();

/* cache aspect-ratio */
const aspects={};
const anchor=document.getElementById('anchor');
function getAspect(el){return el.naturalHeight/el.naturalWidth}

function spawn(assetId){
  const tex=document.getElementById(assetId); if(!tex) return;
  const aspect=aspects[assetId] ||= getAspect(tex);
  const p=document.createElement('a-plane');
  p.setAttribute('src','#'+assetId);
  p.setAttribute('width','1');
  p.setAttribute('height',aspect);
  const isGif=tex.src.toLowerCase().endsWith('.gif');
  p.setAttribute('material', isGif ? 'shader:gif;src:#'+assetId
                                   : 'shader:flat;transparent:true');
  anchor.appendChild(p);
}

/* ------ JEDYNY listener ‚Äì na <a-scene> ------ */
document.getElementById('scene').addEventListener('targetFound',e=>{
  /* ignoruj ‚Äûpuste‚Äù zdarzenia z <video> (detail=null) */
  if(!e.detail || typeof e.detail.index==='undefined') return;

  const idx=e.detail.index;
  console.log('marker found ‚Üí index:',idx,' name:',e.detail.name); // DEBUG
  const asset=mapping[idx]; if(!asset) return;
  if(anchor.children.length) anchor.innerHTML='';   // wyczy≈õƒá ewentualny poprzedni
  spawn(asset);
});

document.getElementById('scene').addEventListener('targetLost',()=>{
  anchor.innerHTML='';
});
})();
</script>
</body>
</html>
